

# Start a container with Postgres  (data dir under /tmp)

docker run --name dev_db -e POSTGRES_USER=mydatabase -e POSTGRES_PASSWORD=mydatabase -v /tmp/postgres:/var/lib/postgresql/data -d postgres


# Inspect / get container info

docker inspect dev_db


# Get container logs (-f is like tail's -f)

docker logs dev_db


# Allow all hosts to replicate with this 'master' DB

echo 'host replication replicator 0.0.0.0/0 trust' >> /tmp/postgres/pg_hba.conf

cat << EOF >> /tmp/postgres/postgresql.conf

wal_level = hot_standby

checkpoint_segments = 8

max_wal_senders = 3

wal_keep_segments = 8

hot_standby = on

EOF


# Restart container

docker restart dev_db


# Run a 'command container' that can access the container dev_db (from previous example). When piinging 'db' it will be redirected to the address of dev_db

# Everything between the commas (sh -c 'SOMETHING') is the command to run in the container.

# This example is for using psql

docker run -it --rm --link dev_db:db -e PGPASSWORD=mydatabase postgres sh -c ' psql -h db mydatabase -Umydatabase'


# Run a 'command container' to create a user for replication

docker run -it --rm --link dev_db:db -e PGPASSWORD=mydatabase postgres sh -c "psql -h db mydatabase -Umydatabase -c \"CREATE USER replicator REPLICATION LOGIN ENCRYPTED PASSWORD 'replpass';\""


# Run a 'command container', like example number 5, with pg_basebackup this time

docker run -e POSTGRES_USER=mydatabase -e POSTGRES_PASSWORD=mydatabase -v /tmp/slave_postgres:/var/lib/postgresql/data --link dev_db:db --rm -it postgres sh -c 'pg_basebackup -h db -D /var/lib/postgresql/data -U replicator -P -v -x'


# Start another container with another DB (data dir under /tmp/slave_postgres)

chmod 700 /tmp/slave_postgres

cat << EOF > /tmp/slave_postgres/recovery.conf

primary_conninfo = 'host=db port=5432 user=replicator password=thepassword'

trigger_file = '/var/lib/postgresql/data/failover'

standby_mode = 'on'

EOF

docker run --name dev_slavedb -e POSTGRES_USER=mydatabase -e POSTGRES_PASSWORD=mydatabase -v /tmp/slave_postgres:/var/lib/postgresql/data --link dev_db:db -d postgres


# Connect to slave DB with psql 

docker run -it --rm --link dev_slavedb:db -e PGPASSWORD=mydatabase postgres sh -c 'psql -h db mydatabase -Umydatabase'
